name: synadia-deploy
{{ include "sd.image" (merge (pick .Values "global") .Values.container.image) }}

securityContext:
  runAsUser: 1000
  allowPrivilegeEscalation: false
  capabilities:
    drop:
    - ALL

args:
{{- if .Values.config.platformURL }}
- --platform-url={{ .Values.config.platformURL }}
{{- end }}
{{- with .Values.config.tls.clientCert }}
{{- if and .secretName (and .cert .key) }}
- --tlscert={{ .dir }}/{{ .cert }}
- --tlskey={{ .dir }}/{{ .key }}
{{- end }}
{{- end }}
{{- with .Values.config.tls.caCerts }}
{{- if and .enabled (or .configMapName .secretName) }}
- --tlsca={{ .dir }}/{{ .key }}
{{- end }}
{{- end }}
{{- if .Values.config.tls.insecureSkipVerify }}
- --insecure
{{- end }}
{{- if .Values.config.healthPort }}
- --health-port={{ .Values.config.healthPort }}
{{- end }}

env:
- name: POD_NAME
  valueFrom:
    fieldRef:
      fieldPath: metadata.name
- name: SYNADIA_DEPLOY_TOKEN
  valueFrom:
    secretKeyRef:
      name: {{ .Values.tokenSecret.name }}
      key: "token"
{{- with .Values.container.env }}
{{- include "sd.env" . }}
{{- end }}

ports:
- name: health
  containerPort: {{ .Values.config.healthPort | default 8080 }}
  protocol: TCP

livenessProbe:
  httpGet:
    path: /healthz
    port: health
  initialDelaySeconds: 5
  periodSeconds: 10
  timeoutSeconds: 5
  failureThreshold: 3

readinessProbe:
  httpGet:
    path: /readyz
    port: health
  initialDelaySeconds: 5
  periodSeconds: 10
  timeoutSeconds: 5
  failureThreshold: 3

startupProbe:
  httpGet:
    path: /healthz
    port: health
  initialDelaySeconds: 5
  periodSeconds: 5
  timeoutSeconds: 5
  failureThreshold: 60

volumeMounts:
# tlsCA
{{- include "sd.tlsCAVolumeMount" $ }}
# secrets
{{- range (include "sd.secretNames" $ | fromJson).secretNames }}
- name: {{ .name | quote }}
  mountPath: {{ .dir | quote }}
{{- end }}